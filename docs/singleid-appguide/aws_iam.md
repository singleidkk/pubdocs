# AWS IAMのアプリ連携
## シングルサインオン

SingleIDに登録したユーザで、AWS IAMと連携し、SAML認証でAWSへシングルサインオンする方法を説明します。
SingleIDのSAML認証設定は、AWSの以下のSAMLメタデータに基づいています。

https://signin.aws.amazon.com/static/saml-metadata.xml

AWSの複数のアカウントと連携したい場合には、２つめ以降のAWSアカウントについて、[AWS IAMのSAML認証設定](#aws-iamのsaml認証設定)以降を繰り返します。

### SingleIDのアプリ登録
1. **SingleID 管理者ポータル＞アプリ連携＞アプリ一覧**画面へ移動します。
2. **カタログ表示**ボタンをクリックします。
    
    [![Screenshot](/images/2022-08-16_3-53-18.png)](/images/2022-08-16_3-53-18.png)

3. アプリカタログが表示されるので、AWS IAMの**登録**ボタンをクリックします。
    
    [![Screenshot](/images/2022-09-18_16-33-36.png)](/images/2022-09-18_16-33-36.png)

4. **アプリ登録**画面がポップアップします。**情報**タブの**名前**に、アプリを識別できるような名前を、半角小文字の英数字、**-（ハイフン）**、**_（アンダースコア）**で設定します。
5. **シングルサインオン**タブに移動します。
    
    [![Screenshot](/images/2022-09-18_17-13-01.png)](/images/2022-09-18_17-13-01.png)

6. **SSO 有効/無効**を有効に設定します。
7. **IdP エンドポイントメタデータ**の**ダウンロード**ボタンをクリックし、メタデータを取得します。このメタデータは、AWS IAMの設定を行うときに必要となります。
8.  **登録**ボタンをクリックして、アプリを登録します。
    
    [![Screenshot](/images/2022-09-18_17-15-13.png)](/images/2022-09-18_17-15-13.png)

### AWS IAMのSAML認証設定
#### IDプロバイダの追加
1. AWSコンソールへ管理者権限を持つユーザでログインし、IAMサービスへ移動します。
2. サイドメニューの**IDプロバイダ**をクリックします。

    [![Screenshot](/images/2022-09-18_18-54-05.png)](/images/2022-09-18_18-54-05.png)

3. **プロバイダを追加**ボタンをクリックします。

    [![Screenshot](/images/2022-09-18_18-56-36.png)](/images/2022-09-18_18-56-36.png)

3. 以下の内容で設定し、**プロバイダを追加**ボタンをクリックします。

    | **IDプロバイダの設定項目** | **設定内容** |
    | :--- | :--- |
    | **プロバイダのタイプ** | SAML |
    | **プロバイダ名** | 任意（例：SingleID） |
    | **メタデータドキュメント** | **ファイルを選択**ボタンをクリックして、SingleIDの**IdPエンドポイントメタデータ**のファイルをアップロードします。 |

    [![Screenshot](/images/2022-09-18_18-59-02.png)](/images/2022-09-18_18-59-02.png)

4. 追加したIDプロバイダの設定を開いて、ARNの情報をコピーしておきます。SingleIDのアプリロールの設定で使用します。

    [![Screenshot](/images/2022-09-18_19-08-24.png)](/images/2022-09-18_19-08-24.png)

#### IAMロールの追加
1. AWSコンソールへ管理者権限を持つユーザでログインし、IAMサービスへ移動します。
2. サイドメニューの**ロール**をクリックします。

    [![Screenshot](/images/2022-09-18_19-15-23.png)](/images/2022-09-18_19-15-23.png)

3. **ロールを作成**ボタンをクリックします。

    [![Screenshot](/images/2022-09-18_19-18-20.png)](/images/2022-09-18_19-18-20.png)

4. **ステップ１（信頼されたエンティティを選択）**では、以下の内容を設定します。**次へ**ボタンをクリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **信頼されたエンティティタイプ** | SAML2.0フェデレーション |
    | **SAML 2.0 ベースのプロバイダー** | 追加したIDプロバイダ名を選択（例：SingleID） |
    | **プログラムと AWS マネジメントコンソールへのアクセスを許可する** | 選択 |

    [![Screenshot](/images/2022-09-18_19-21-11.png)](/images/2022-09-18_19-21-11.png)

5. **ステップ２（許可を追加）**では、ロールにアタッチするポリシーを設定します。ここでは、**EC2FullAccess**をアタッチしています。**次へ**ボタンをクリックします。

    [![Screenshot](/images/2022-09-18_19-37-44.png)](/images/2022-09-18_19-37-44.png)

6. **ステップ３（名前、確認、および作成）**では、任意のロール名を設定します。**ロールを作成**ボタンをクリックします。

    [![Screenshot](/images/2022-09-18_19-40-34.png)](/images/2022-09-18_19-40-34.png)

7. 追加したIAMロールの設定を開いて、ARNの情報をコピーしておきます。SingleIDのアプリロールの設定で使用します。

    [![Screenshot](/images/2022-09-19_15-05-49.png)](/images/2022-09-19_15-05-49.png)

### アプリにユーザ追加
1. **SingleID 管理者ポータル＞アプリ連携＞アプリ一覧**画面へ移動します。
2. 登録したアプリの列にある**チェックボックス**を選択します。
3. **ユーザ追加**ボタンをクリックします。
    
    [![Screenshot](/images/image-4.png)](/images/image-4.png)

4. **ユーザ追加**画面がポップアップします。アプリへ追加したい**ユーザ名**を選択し、**登録**ボタンをクリックして、アプリへユーザを追加します。
    
    [![Screenshot](/images/image-5.png)](/images/image-5.png)

### アプリロールの設定
#### アプリロールの登録
1. **SingleID 管理者ポータル＞アプリ連携＞アプリ一覧**画面へ移動します。
2. 登録したアプリの**アプリロール**ボタンをクリックします。
3. **アプリロール登録**ボタンをクリックします。

    [![Screenshot](/images/2022-09-19_15-24-03.png)](/images/2022-09-19_15-24-03.png)

4. **アプリロール登録**画面にロール名を入力します。AWS IAMのIDプロバイダのARNとAWS IAMロールのARNをカンマでつなげた文字列をロール名とします。（例：`arn:aws:iam::000000000000:saml-provider/SingleID,arn:aws:iam::000000000000:role/singleid-role-saml`）

    [![Screenshot](/images/2022-09-19_15-26-14.png)](/images/2022-09-19_15-26-14.png)

#### アプリロールにユーザを関連付け
1. **アプリロールに関連付いたユーザ一覧**から**ユーザ追加**ボタンをクリックします。

    [![Screenshot](/images/2022-09-19_15-58-02.png)](/images/2022-09-19_15-58-02.png)

2. **アプリロールユーザ追加**画面で、アプリロールに関連付けるユーザを選択し、**登録**ボタンをクリックします。アプリにユーザを追加したユーザのみ、ここで選択可能です。

    [![Screenshot](/images/2022-09-19_16-00-27.png)](/images/2022-09-19_16-00-27.png)

## 動作確認
### ブラウザからのログイン
1. アプリに追加したユーザでユーザポータルへログインします。
2. アプリケーションへ移動します。
3. アプリ登録時に設定したアプリの名前をクリックします。
4. SingleIDのログイン画面が表示されます。すでに、SingleIDへログイン中であれば、ログイン画面は表示されず、AWSコンソールへログインできます。
    
    [![Screenshot](/images/image-7-1024x462.png)](/images/image-7-1024x462.png)

    複数のAWSアカウントをSingleIDと連携させる設定をした場合には、認証成功後に、ロールの選択画面が表示されます。

    [![Screenshot](/images/2022-09-19_16-29-03.png)](/images/2022-09-19_16-29-03.png)


