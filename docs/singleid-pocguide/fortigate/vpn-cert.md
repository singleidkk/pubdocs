# リモートアクセスVPN-クライアント証明書認証
文書更新日:2025-03-09

## 目的
* SingleIDのユーザで、FortiGateへVPNを使ってリモートアクセスします。
* 接続する際の認証方式は、クライアント証明書認証です。

## 設定方法
### SingleIDのユーザの作成
1. **SingleID 管理者ポータル＞ユーザ**画面へ移動します。
2. **登録**ボタンをクリックします。**ユーザ登録**画面がポップアップします。
3. **ユーザ登録**画面の**基本情報**を入力します。
4. **登録**ボタンをクリックします。

### SingleIDのクライアント証明書の発行
1. **SingleID 管理者ポータル＞ユーザ**画面へ移動します。
2. クライアント証明書を発行したいユーザの行にある**チェックボックス**を選択します。
3. **選択実行**ボタンの▼をクリックし、プルダウンメニューの**証明書の発行**を選択します。
4. **証明書発行**画面がポップアップします。
5. **プロファイル**（例：デフォルト）および**配布形式**（例：一般）を選択します。
6. **発行**ボタンをクリックして、クライアント証明書を発行します。ユーザのメールアドレス宛に発行されたクライアント証明書のダウンロードリンクが送信されます。

### SingleIDのサーバ証明書の発行とダウンロード
1. **SingleID 管理者ポータル＞認証＞証明書＞証明書**タブへ移動します。
2. **発行**ボタンの▼をクリックし、プルダウンメニューの**サーバ証明書**を選択します。
4. **サーバ証明書の発行**画面がポップアップします。
5. 以下を設定します。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **サーバ名** | VPNクライアントが接続するIPアドレスまたはホスト名（FQDN）です。 |
    | **サブジェクトの代替名** | サーバ名にIPアドレスを設定した場合には、IPを選択します。サーバ名にホスト名を設定した場合には、DNSを選択します。 |
    | **有効期間** | 1年、5年、10年から選択します。（例：10年） |

6. **発行**ボタンをクリックして、サーバ証明書を発行します。
7. 発行されたサーバ証明書の行にある**チェックボックス**を選択します。
8. **選択実行**ボタンの▼をクリックし、プルダウンメニューの**証明書のダウンロード**を選択します。
9. ZIP圧縮されたP12形式のサーバ証明書がダウンロードされます。

    !!! info
        発行された証明書をデバイスへインストールする場合には、パスワードの入力が要求されます。パスワードは、サーバ名と同一です。（例：サーバ名が10.10.10.10の場合、サーバ証明書のパスワードは、10.10.10.10です。）

### SingleIDの中間CA証明書のダウンロード
1. **SingleID 管理者ポータル＞認証＞証明書＞基本情報**タブへ移動します。
2. **中間CA**ブロックの中間CAのタイトル文字の隣の:fontawesome-solid-cloud-arrow-down:をクリックします。**ダウンロード**画面がポップアップします。
3. **ダウンロード**ボタンをクリックして、SingleIDの中間CA証明書をダウンロードします。

!!! warning
    誤って、ルートCA証明書をダウンロードしないようにご注意ください。ルートCA証明書のダウンロードは必要ありません。

### FortiGateへ中間CA証明書を追加
1. **FortiGate 管理GUI＞システム＞証明書**画面へ移動します。

    !!! info
        メニューに**証明書**がない場合には、**FortiGate 管理GUI＞システム＞表示機能設定**画面で、**証明書**の表示を有効にします。

2. **作成/インポート＞CA証明書**ボタンをクリックします。**CA証明書をインポート**画面が表示されます。
3. 以下を設定し、**OK**ボタンをクリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **タイプ** | **ファイル**を選択します。 |
    | **アップロード** | [SingleIDの中間CA証明書のダウンロード](#singleidの中間ca証明書のダウンロード)の手順でダウンロードしたファイルを選択します。 |
    
    !!! danger
        **SingleIDのルートCA証明書をFortiGateへインポートしないようにしてください。意図しないVPN接続の認証が成功してしまいます。**
        
        リモートアクセスクライアントからFortiGateへのVPN接続時、SingleIDのルートCA証明書がFortiGateにインポートされていると、SingleIDのルートCAを発行元とするどんな中間CAが発行したクライアント証明書であっても、証明書のパスの検証に成功してしまいます。

    [![Screenshot](/images/fortigate-19.png)](/images/fortigate-19.png)

### FortiGateへ証明書失効リスト（CRL）の設定
1. **FortiGate 管理GUI＞システム＞証明書**画面へ移動します。
2. **作成/インポート＞CRL**ボタンをクリックします。**CRLをインポート**画面が表示されます。
3. 以下を設定し、**OK**ボタンをクリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **インポート方式** | **オンライン更新**を選択します。 |
    | **HTTPサーバのURL** | **SingleID 管理者ポータル＞認証＞証明書＞基本情報**タブの**中間CAの失効リストの配布ポイント**です。 |

    [![Screenshot](/images/fortigate-20.png)](/images/fortigate-20.png)

4. 定期的（1時間ごと）に証明書失効リスト（CRL）を更新するために、FortiGate CLIから**set update-interval 3600**を以下のように設定します。

    ``` title="FortiGate CLI"
    config vpn certificate crl
        edit "CRL_1"
            set update-interval 3600
        next
    end
    ```
### FortiGateへサーバ証明書を追加
1. **FortiGate 管理GUI＞システム＞証明書**画面へ移動します。
2. **作成/インポート＞証明書**ボタンをクリックします。**証明書の作成**画面が表示されます。
3. **証明書をインポート**ボタンをクリックします。
4. 以下を設定し、**作成**ボタンをクリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **タイプ** | **PKCS12証明書**を選択します。 |
    | **キーファイルのある証明書** | [SingleIDのサーバ証明書の発行とダウンロード](#singleidのサーバ証明書の発行とダウンロード)の手順でダウンロードしたZIPファイルを解凍します。そして、拡張子がP12のファイルを選択します。 |
    | **パスワード** | 証明書ファイルの拡張子を除いた部分がパスワードです。（例：10.10.10.10.p12というファイルの場合には、パスワードは、10.10.10.10です。）|
    | **証明書名** | 証明書ファイルを選択しアップロードすると自動で入力されます。 |

    [![Screenshot](/images/2025-03-08_17-30-50.png)](/images/2025-03-08_17-30-50.png)

5. **OK**ボタンをクリックします。

### FortiGateのVPNの設定
1. **FortiGate 管理GUI＞VPN＞IPsecウィザード**画面へ移動します。
2. 以下の項目を設定し、**次へ**ボタンをクリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **名前** | 任意の文字列を設定します。（例：IPsecVPN） |
    | **テンプレートタイプ** | **リモートアクセス**を選択します。 |
    | **リモートデバイスタイプ** | **クライアントベース**　**FortiClient**を選択します。 |

    [![Screenshot](/images/fortigate-3.png)](/images/fortigate-3.png)

3. 以下の項目を設定し、**次へ**ボタンをクリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **着信インターフェース** | FortiGateのWAN側のインターフェースです。環境により異なります。 |
    | **認証方式** | **シグネチャ**を選択します。 |
    | **証明書名** | [FortiGateへサーバ証明書を追加](#fortigateへサーバ証明書を追加)で追加したサーバ証明書を選択します。 |
    | **ユーザグループ** | 空欄にします。 |
    | **ピア証明書CA** | [FortiGateへ中間CA証明書を追加](#fortigateへ中間ca証明書を追加)の手順で追加した中間CAの証明書を選択します。 |

    [![Screenshot](/images/2025-03-08_18-12-01.png)](/images/2025-03-08_18-12-01.png)

4. 以下の項目を設定し、**次へ**ボタンを クリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **ローカルインターフェース** | FortiGateのLAN側のインターフェースです。環境により異なります。 |
    | **ローカルアドレス** | LAN側ネットワークを指定します。（例：internal） |
    | **クライアントアドレス範囲** | VPNクライアントに割り当てるIPアドレスの範囲です。環境により異なります。 |
    | **サブネットマスク** | **255.255.255.255**を設定します。 |

    [![Screenshot](/images/fortigate-5.png)](/images/fortigate-5.png)

5. **次へ**ボタンをクリックします。

    [![Screenshot](/images/fortigate-6.png)](/images/fortigate-6.png)

6. 設定を確認し、**作成**ボタンをクリックします。
7. **FortiGate 管理GUI＞VPN＞IPsecトンネル**画面へ移動します。
8. ウィザードによって作成されたVPNトンネルを選択し、**編集**ボタンをクリックします。**VPNトンネルの編集**画面が表示されます。
9.  **カスタムトンネルへコンバート**ボタンをクリックします。

    [![Screenshot](/images/2025-03-08_19-53-06.png)](/images/2025-03-08_19-53-06.png)

10. **XAUTH**のセクションで**編集**ボタンをクリックし、**タイプ**を**無効**にします。
11. **OK**ボタンをクリックします。

## 動作確認方法
Windows端末からクライアント証明書によるリモートアクセスVPNの認証が可能なことを確認します。

### クライアント証明書のダウンロード
1. **SingleIDシステム管理**から届いたメールを開きます。
2. **ダウンロード**リンクをクリックします。P12形式のクライアント証明書がダウンロードされます。

    [![Screenshot](/images/2021-09-02_19-10-04-1024x489-1.png)](/images/2021-09-02_19-10-04-1024x489-1.png)

!!! info
    もし、PCでメールを受信し、スマートフォンやタブレットにクライアント証明書をインストールしたい場合には、メールに添付されているQRコードを スマートフォンやタブレットで読み取ります。クライアント証明書のダウンロードURLを認識しますので、そのURLへアクセスすることで、 スマートフォンやタブレット にもクライアント証明書をダウンロードできます。

### クライアント証明書のインストール
1. ダウンロードしたP12形式のクライアント証明書ファイルをダブルクリックします。
2. 保存場所として**現在のユーザー**を選択し、**次へ**ボタンをクリックします。

    [![Screenshot](/images/image-certinstall-1.png)](/images/image-certinstall-1.png)

3. ダウンロードしたP12形式のファイル名とパスが正しく入力されていることを確認し、**次へ**ボタンをクリックします。

    [![Screenshot](/images/image-certinstall-2.png)](/images/image-certinstall-2.png)

4. **パスワード**に、クライアント証明書のパスワードを入力します。クライアント証明書のパスワードは、ユーザ名と同一です。（例：ユーザ名が、user1の場合、クライアント証明書のパスワードは、user1です。）**次へ**ボタンをクリックします。

    [![Screenshot](/images/image-certinstall-3.png)](/images/image-certinstall-3.png)

5. **証明書の種類に基づいて、自動に証明書ストアを選択する**が選択されていることを確認し、**次へ**ボタンをクリックします。

    [![Screenshot](/images/image-certinstall-4.png)](/images/image-certinstall-4.png)

6. **完了**ボタンをクリックし、証明書をインストールします。

    [![Screenshot](/images/image-certinstall-5.png)](/images/image-certinstall-5.png)

7. クライアント証明書のインストールが成功しました。

    [![Screenshot](/images/image-certinstall-6.png)](/images/image-certinstall-6.png)

### リモートアクセスクライアントのインストール
FortiGateのリモートアクセスクライアントである、FortiClientをインストールしていない場合には、以下よりダウンロードしてインストールします。

[ダウンロード](https://www.fortinet.com/support/product-downloads#vpn){ target=_blank .md-button .md-button--primary }

### 接続先の設定

1. **FortiClient**を起動して、新規VPN接続を作成します。以下を設定します。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **VPN** | **IPsecVPN**を選択します。 |
    | **接続名** | 任意の文字列を設定します。（例：SingleID_Cert） |
    | **リモートGW** | VPNクライアントが接続するIPアドレスです。 |
    | **認証方法** | **X.509証明書**を選択します。 |
    | **クライアント証明書** | [クライアント証明書のインストール](#クライアント証明書のインストール)の手順でインストールしたクライアント証明書を選択します。 |
    | **認証(XAuth)** | **無効**を選択します。 |

    [![Screenshot](/images/2025-03-08_20-04-10.png)](/images/2025-03-08_20-04-10.png)

2. **保存**ボタンをクリックします。

### VPN接続

1. 以下を設定し、**接続**ボタンをクリックします。

    | **設定項目** | **設定内容** |
    | :--- | :--- |
    | **VPN名称** | [接続先の設定](#vpn接続)の手順で作成した接続先を選択します。（例：SingleID_Cert） |
    | **クライアント証明書** | [クライアント証明書のインストール](#クライアント証明書のインストール)の手順でインストールしたクライアント証明書を選択します。 |

    [![Screenshot](/images/fortigate-24.png)](/images/fortigate-24.png)

2. ログインが成功することを確認します。

    [![Screenshot](/images/fortigate-25.png)](/images/fortigate-25.png)
